#!/bin/bash
#================================================================
# btb-phylo
#================================================================

SCRIPT="${0##*/}"

parse_args() {
    THREADS="1"
    DOCKER=0
    SOPTS="j:"

    TMP=$(getopt -o "$SOPTS" -n "$SCRIPT" -- "$@") || exit 1

    eval set -- "$TMP"
    unset TMP

    while true; do
        case "$1" in
            -j)
                THREADS=$2
                shift
                ;;
            --)
                shift
                break
                ;;

        esac
        shift
    done

    if (( $#<3 ))
    then
        printf "Must include positional arguments of paths to: results folder, "
        printf "consensus folder and configuraiton file\n"
    fi

    RESULTS=$1
    CONSENSUS=$2
    CONFIG=$3
    shift
    shift
    shift

    nargs=$#
    for ((i=0; i<nargs; ++i)); do
        if [ $1 == "with-docker" ]
        then
        DOCKER=1
        else
        printf "Unrecognised argument: %s. Please include positional arguments for " "$1"
        printf "paths to: results folder, consensus folder and configuration file. "
        printf "Additional optional arguments include 'with-docker' and '-j' (see Readme)\n"
        fi
        shift
    done
}

parse_args "$@"


if [ $DOCKER ]; then
    echo "Running btb-phylo with docker"
    docker pull aphacsubot/btb-phylo:dockerize
    docker run --rm -it --mount type=bind,source=$RESULTS,target=/results --mount type=bind,source=$CONSENSUS,target=/consensus --mount type=bind,source=$CONFIG,target=/config.json aphacsubot/btb-phylo:dockerize /results /consensus /config.json $THREADS
else
    python btb_phylo.py full_pipeline $RESULTS $CONSENSUS -j $THREADS --config $CONFIG 
fi